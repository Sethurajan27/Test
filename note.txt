var logs = [];

function logEvent(message) {
  const time = new Date().toLocaleTimeString();
  logs.push(`[${time}] ${message}`);
  if (logs.length > 1000) logs.shift();
}

function startMonitoring() {
  logEvent("Start monitoring called.");

  const props = PropertiesService.getScriptProperties();
  props.setProperty('monitoring', 'true');

  const domainRes = UrlFetchApp.fetch('https://api.mail.tm/domains');
  const domain = JSON.parse(domainRes.getContentText())['hydra:member'][0].domain;

  const email = `user${Date.now()}@${domain}`;
  const password = `P@ss${Date.now()}`;

  logEvent("Creating temp email: " + email);

  UrlFetchApp.fetch('https://api.mail.tm/accounts', {
    method: 'POST',
    contentType: 'application/json',
    payload: JSON.stringify({ address: email, password })
  });

  const loginRes = UrlFetchApp.fetch('https://api.mail.tm/token', {
    method: 'POST',
    contentType: 'application/json',
    payload: JSON.stringify({ address: email, password })
  });

  const token = JSON.parse(loginRes.getContentText()).token;

  logEvent("Temp mail created and token received.");

  // Use same spreadsheet
  let sheetId = props.getProperty('sheetId');
  let sheet;
  if (sheetId) {
    sheet = SpreadsheetApp.openById(sheetId).getActiveSheet();
    logEvent("Using existing spreadsheet.");
  } else {
    const newSheet = SpreadsheetApp.create("TempMail Logs");
    sheetId = newSheet.getId();
    sheet = newSheet.getActiveSheet();
    sheet.appendRow(["MyMailId", "Timestamp", "SenderMailId", "Subject", "OTP", "VerificationLink", "Body"]);
    props.setProperty('sheetId', sheetId);
    logEvent("Created new spreadsheet.");
  }

  sheet.appendRow([email, new Date(), "NULL", "STARTED", "NULL", "NULL", "NULL"]);
  logEvent("Logged STARTED row.");

  props.setProperties({
    token,
    email,
    sheetId
  });

  return "ok";
}

function stopMonitoring() {
  logEvent("Stop monitoring called.");
  PropertiesService.getScriptProperties().setProperty('monitoring', 'false');
  return "ok";
}

function fetchInbox() {
  logEvent("Inbox fetch triggered.");
  const props = PropertiesService.getScriptProperties();
  if (props.getProperty('monitoring') !== 'true') {
    logEvent("Monitoring not active.");
    return;
  }

  const token = props.getProperty('token');
  const email = props.getProperty('email');
  const sheetId = props.getProperty('sheetId');
  const sheet = SpreadsheetApp.openById(sheetId).getActiveSheet();

  const response = UrlFetchApp.fetch("https://api.mail.tm/messages", {
    headers: { Authorization: `Bearer ${token}` }
  });

  const messages = JSON.parse(response.getContentText())['hydra:member'];
  const existing = sheet.getDataRange().getValues().map(row => row[1] + row[3]);

  messages.forEach(msg => {
    const key = msg.createdAt + msg.subject;
    if (existing.includes(key)) return;

    const fullMsg = JSON.parse(UrlFetchApp.fetch(`https://api.mail.tm/messages/${msg.id}`, {
      headers: { Authorization: `Bearer ${token}` }
    }).getContentText());

    const otp = fullMsg.text.match(/\b\d{4,8}\b/);
    const link = fullMsg.text.match(/https?:\/\/[^\s]+/);

    const row = [
      email,
      msg.createdAt,
      msg.from.address,
      msg.subject,
      otp ? otp[0] : "NULL",
      link ? link[0] : "NULL",
      fullMsg.text
    ];

    sheet.appendRow(row);
    logEvent(`Message logged: From ${msg.from.address} | Subject: ${msg.subject}`);
  });
}

function getLogs() {
  return logs;
}

function getSheetData() {
  const props = PropertiesService.getScriptProperties();
  const sheetId = props.getProperty('sheetId');
  if (!sheetId) return [];

  try {
    const sheet = SpreadsheetApp.openById(sheetId).getActiveSheet();
    return sheet.getDataRange().getValues();
  } catch (e) {
    logEvent("Error accessing spreadsheet: " + e.message);
    return [];
  }
}

function getEmail() {
  return PropertiesService.getScriptProperties().getProperty('email') || '';
}

function doGet() {
  return HtmlService.createHtmlOutputFromFile('Index');
}







<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial; padding: 20px; }
      button { padding: 10px 20px; margin: 5px; font-size: 16px; }
      pre {
        background: #f4f4f4;
        padding: 10px;
        border-radius: 5px;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <h2>üì¨ Temp Mail Monitor</h2>
    <button onclick="start()">‚ñ∂ Start Monitoring</button>
    <button onclick="stop()">‚èπ Stop Monitoring</button>
    <p id="email">üìß Email: <em>not started</em></p>

    <h3>üîß Process Log</h3>
    <div id="process"><pre>Waiting for logs...</pre></div>

    <h3>üìÑ Spreadsheet Log</h3>
    <div id="sheet"><pre>Waiting for spreadsheet data...</pre></div>

    <script>
      function start() {
        google.script.run.withSuccessHandler(() => {
          getEmail();
        }).startMonitoring();
      }

      function stop() {
        google.script.run.stopMonitoring();
        document.getElementById("email").innerText = "üìß Email: monitoring stopped";
      }

      function getEmail() {
        google.script.run.withSuccessHandler(email => {
          document.getElementById("email").innerText = "üìß Email: " + email;
        }).getEmail();
      }

      function updateLogs() {
        google.script.run.withSuccessHandler(renderProcessLog).getLogs();
        google.script.run.withSuccessHandler(renderSheetLog).getSheetData();
        google.script.run.fetchInbox(); // fetch inbox in background
      }

      function renderProcessLog(logs) {
        document.getElementById("process").innerHTML = "<pre>" + logs.join("\n") + "</pre>";
      }

      function renderSheetLog(data) {
        if (!data || data.length === 0) {
          document.getElementById("sheet").innerHTML = "<pre>No spreadsheet data</pre>";
          return;
        }
        const lines = data.map(row => row.join(" | "));
        document.getElementById("sheet").innerHTML = "<pre>" + lines.join("\n") + "</pre>";
      }

      getEmail();
      updateLogs();
      setInterval(updateLogs, 15000); // every 15s
    </script>
  </body>
</html>
