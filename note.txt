function startMonitoring() {
  const scriptProps = PropertiesService.getScriptProperties();

  // Skip if already started
  if (scriptProps.getProperty('monitoring') === 'true') {
    return ContentService.createTextOutput("Already started");
  }

  // Get domain for temp email
  const domainRes = UrlFetchApp.fetch('https://api.mail.tm/domains');
  const domain = JSON.parse(domainRes.getContentText())['hydra:member'][0].domain;
  const email = `user${Date.now()}@${domain}`;
  const password = `P@ssword${Date.now()}`;

  // Create account
  UrlFetchApp.fetch('https://api.mail.tm/accounts', {
    method: 'POST',
    contentType: 'application/json',
    payload: JSON.stringify({ address: email, password })
  });

  // Log in to get token
  const loginRes = UrlFetchApp.fetch('https://api.mail.tm/token', {
    method: 'POST',
    contentType: 'application/json',
    payload: JSON.stringify({ address: email, password })
  });

  const loginData = JSON.parse(loginRes.getContentText());
  const token = loginData.token;

  // Create Google Sheet
  const sheet = SpreadsheetApp.create("TempMail Inbox");
  const sheetId = sheet.getId();
  const header = ["MyMailId", "Timestamp", "SenderMailId", "Subject", "OTP", "VerificationLink", "Body"];
  sheet.getActiveSheet().appendRow(header);
  sheet.getActiveSheet().appendRow([email, new Date(), "NULL", "STARTED", "NULL", "NULL", "NULL"]);

  // Save persistent properties
  scriptProps.setProperties({
    monitoring: 'true',
    email,
    password,
    token,
    sheetId
  });

  // Set time-based trigger
  ScriptApp.newTrigger('fetchInbox')
    .timeBased()
    .everyMinutes(1)
    .create();

  return ContentService.createTextOutput("Monitoring started with: " + email);
}

function stopMonitoring() {
  const scriptProps = PropertiesService.getScriptProperties();
  scriptProps.setProperty('monitoring', 'false');

  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'fetchInbox') {
      ScriptApp.deleteTrigger(trigger);
    }
  });

  return ContentService.createTextOutput("Monitoring stopped.");
}

function fetchInbox() {
  const props = PropertiesService.getScriptProperties();
  if (props.getProperty('monitoring') !== 'true') return;

  const token = props.getProperty('token');
  const sheetId = props.getProperty('sheetId');
  const email = props.getProperty('email');

  const res = UrlFetchApp.fetch("https://api.mail.tm/messages", {
    headers: { Authorization: `Bearer ${token}` }
  });

  const messages = JSON.parse(res.getContentText())['hydra:member'];
  const sheet = SpreadsheetApp.openById(sheetId).getActiveSheet();
  const rows = sheet.getDataRange().getValues();

  messages.forEach(msg => {
    if (rows.some(row => row[1] === msg.createdAt && row[3] === msg.subject)) return;

    const msgRes = UrlFetchApp.fetch(`https://api.mail.tm/messages/${msg.id}`, {
      headers: { Authorization: `Bearer ${token}` }
    });

    const fullMsg = JSON.parse(msgRes.getContentText());

    const otpMatch = fullMsg.text.match(/\b\d{4,8}\b/);
    const linkMatch = fullMsg.text.match(/https?:\/\/[^\s]+/g);

    const row = [
      email,
      msg.createdAt,
      msg.from.address,
      msg.subject,
      otpMatch ? otpMatch[0] : 'NULL',
      linkMatch ? linkMatch[0] : 'NULL',
      fullMsg.text
    ];
    sheet.appendRow(row);
  });
}

function getLogs() {
  const sheetId = PropertiesService.getScriptProperties().getProperty('sheetId');
  if (!sheetId) return [];

  const sheet = SpreadsheetApp.openById(sheetId).getActiveSheet();
  return sheet.getDataRange().getValues();
}

function doGet() {
  return HtmlService.createHtmlOutputFromFile('Index');
}










<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial, sans-serif; padding: 20px; }
      button { margin: 5px; padding: 10px 20px; font-size: 16px; }
      pre { background: #f4f4f4; padding: 12px; border-radius: 6px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
    </style>
  </head>
  <body>
    <h2>üì¨ Temp Mail Inbox Monitor</h2>
    <button onclick="start()">‚ñ∂ Start Monitoring</button>
    <button onclick="stop()">‚èπ Stop Monitoring</button>

    <h3>üìÑ Logs</h3>
    <div id="logs"><pre>Loading logs...</pre></div>

    <script>
      function start() {
        google.script.run.withSuccessHandler(alert).startMonitoring();
      }

      function stop() {
        google.script.run.withSuccessHandler(alert).stopMonitoring();
      }

      function fetchLogs() {
        google.script.run.withSuccessHandler(renderLogs).getLogs();
      }

      function renderLogs(data) {
        const formatted = data.map(row => row.join(" | ")).join("\n");
        document.getElementById("logs").innerHTML = `<pre>${formatted}</pre>`;
      }

      setInterval(fetchLogs, 5000);
      fetchLogs(); // Load logs immediately
    </script>
  </body>
</html>
