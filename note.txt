let token = '';
let account = {};
let lastMessageId = '';

function doGet() {
  return HtmlService.createHtmlOutputFromFile('Page')
    .setTitle('Mail.tm Inbox Monitor')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function startMonitoring() {
  token = '';
  account = {};
  lastMessageId = '';

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  sheet.clear();
  sheet.appendRow(['Mail Address', 'Timestamp', 'Sender', 'Subject', 'OTP', 'Body']);

  // Generate email & get token
  const domain = UrlFetchApp.fetch('https://api.mail.tm/domains').getContentText();
  const domainName = JSON.parse(domain)['hydra:member'][0].domain;

  const email = 'temp' + Math.floor(Math.random() * 100000) + '@' + domainName;
  const password = 'Test1234!';

  UrlFetchApp.fetch('https://api.mail.tm/accounts', {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify({ address: email, password: password }),
    muteHttpExceptions: true
  });

  const login = UrlFetchApp.fetch('https://api.mail.tm/token', {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify({ address: email, password: password })
  });

  const loginData = JSON.parse(login.getContentText());
  token = loginData.token;
  account.email = email;
  account.password = password;

  // Log the mail ID once
  sheet.appendRow([email, new Date(), '', '', '', '']);

  ScriptApp.newTrigger('pollInbox')
    .timeBased()
    .everyMinutes(1)
    .create();

  return { email };
}

function pollInbox() {
  if (!token) return;

  const response = UrlFetchApp.fetch('https://api.mail.tm/messages', {
    method: 'get',
    headers: {
      Authorization: 'Bearer ' + token
    }
  });

  const messages = JSON.parse(response.getContentText())['hydra:member'];

  if (messages.length === 0 || messages[0].id === lastMessageId) return;

  const messageId = messages[0].id;
  lastMessageId = messageId;

  const messageDetails = UrlFetchApp.fetch(`https://api.mail.tm/messages/${messageId}`, {
    method: 'get',
    headers: {
      Authorization: 'Bearer ' + token
    }
  });

  const msg = JSON.parse(messageDetails.getContentText());
  const sender = msg.from.address;
  const subject = msg.subject;
  const body = msg.text;
  const timestamp = msg.createdAt;

  const otp = extractOTP(body);

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  sheet.appendRow(['', timestamp, sender, subject, otp, body]);
}

function extractOTP(text) {
  const match = text.match(/\b\d{4,8}\b/);
  return match ? match[0] : '';
}

function getEmailAddress() {
  return account.email || '';
}












<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial; padding: 20px; }
      .log { margin-top: 20px; white-space: pre-wrap; background: #f5f5f5; padding: 10px; border-radius: 5px; }
    </style>
  </head>
  <body>
    <h2>Mail.tm Inbox Monitor</h2>
    <button onclick="start()">Start Monitoring</button>
    <div class="log" id="log"></div>

    <script>
      function start() {
        document.getElementById("log").innerText = "Starting...";
        google.script.run.withSuccessHandler(updateUI).startMonitoring();
      }

      function updateUI(data) {
        document.getElementById("log").innerText = `Monitoring started.\nMail ID: ${data.email}\n\nCheck your inbox by sending test emails to this address. Logs will appear in your Google Sheet.`;
      }
    </script>
  </body>
</html>
