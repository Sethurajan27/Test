function doGet() {
  return HtmlService.createHtmlOutputFromFile('Page')
    .setTitle('Mail.tm Inbox Monitor')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function startMonitoring() {
  const props = PropertiesService.getScriptProperties();
  props.deleteAllProperties();

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  sheet.clear();
  sheet.appendRow(['Type', 'Timestamp', 'Email Address', 'Sender', 'Subject', 'OTP', 'Body']);

  const domains = JSON.parse(UrlFetchApp.fetch('https://api.mail.tm/domains').getContentText());
  const domain = domains['hydra:member'][0].domain;

  const email = 'temp' + Math.floor(Math.random() * 100000) + '@' + domain;
  const password = 'Test1234!';

  UrlFetchApp.fetch('https://api.mail.tm/accounts', {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify({ address: email, password: password }),
    muteHttpExceptions: true
  });

  const loginResponse = UrlFetchApp.fetch('https://api.mail.tm/token', {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify({ address: email, password: password })
  });

  const loginData = JSON.parse(loginResponse.getContentText());
  props.setProperty('TOKEN', loginData.token);
  props.setProperty('EMAIL', email);
  props.setProperty('PASSWORD', password);
  props.setProperty('LAST_ID', '');

  const log = [`[${new Date().toLocaleString()}] Monitoring started. Email: ${email}`];
  props.setProperty('LOG', JSON.stringify(log));

  const trigger = ScriptApp.newTrigger('pollInbox')
    .timeBased()
    .everyMinutes(1)
    .create();
  props.setProperty('TRIGGER_ID', trigger.getUniqueId());

  return { email, log: log.join('\n') };
}

function pollInbox() {
  const props = PropertiesService.getScriptProperties();
  const token = props.getProperty('TOKEN');
  const email = props.getProperty('EMAIL');
  const lastId = props.getProperty('LAST_ID');
  const logs = JSON.parse(props.getProperty('LOG') || '[]');

  if (!token) return;

  const inbox = UrlFetchApp.fetch('https://api.mail.tm/messages', {
    method: 'get',
    headers: { Authorization: 'Bearer ' + token }
  });
  const messages = JSON.parse(inbox.getContentText())['hydra:member'];
  if (messages.length === 0 || messages[0].id === lastId) return;

  const msg = messages[0];
  props.setProperty('LAST_ID', msg.id);

  const details = UrlFetchApp.fetch(`https://api.mail.tm/messages/${msg.id}`, {
    method: 'get',
    headers: { Authorization: 'Bearer ' + token }
  });
  const content = JSON.parse(details.getContentText());

  const timestamp = content.createdAt;
  const sender = content.from.address;
  const subject = content.subject;
  const body = content.text;
  const otp = extractOTP(body);

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  sheet.appendRow(['EMAIL', timestamp, email, sender, subject, otp, body]);

  const logLine = `[${new Date().toLocaleTimeString()}] New email from ${sender} with OTP: ${otp}`;
  logs.push(logLine);
  props.setProperty('LOG', JSON.stringify(logs));
}

function extractOTP(text) {
  const match = text.match(/\b\d{4,8}\b/);
  return match ? match[0] : '';
}

function getLiveLog() {
  const props = PropertiesService.getScriptProperties();
  const logs = JSON.parse(props.getProperty('LOG') || '[]');
  return logs.join('\n');
}

function stopMonitoring() {
  const props = PropertiesService.getScriptProperties();
  const logs = JSON.parse(props.getProperty('LOG') || '[]');

  const triggers = ScriptApp.getProjectTriggers();
  for (let t of triggers) {
    if (t.getHandlerFunction() === 'pollInbox') {
      ScriptApp.deleteTrigger(t);
    }
  }

  logs.push(`[${new Date().toLocaleString()}] Monitoring stopped.`);
  props.setProperty('LOG', JSON.stringify(logs));
  return { stopped: true, log: logs.join('\n') };
}














<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial; padding: 20px; }
      button { margin-right: 10px; }
      #log { white-space: pre-wrap; background: #f0f0f0; padding: 10px; margin-top: 20px; border-radius: 6px; }
    </style>
  </head>
  <body>
    <h2>Mail.tm Inbox Monitor</h2>
    <button onclick="start()">Start Monitoring</button>
    <button onclick="stop()">Stop Monitoring</button>
    <div id="log">Press "Start Monitoring" to begin...</div>

    <script>
      let polling = null;

      function start() {
        document.getElementById('log').innerText = 'Starting monitor...';
        google.script.run.withSuccessHandler(data => {
          document.getElementById('log').innerText = data.log;
          if (polling) clearInterval(polling);
          polling = setInterval(() => {
            google.script.run.withSuccessHandler(log => {
              document.getElementById('log').innerText = log;
            }).getLiveLog();
          }, 10000);
        }).startMonitoring();
      }

      function stop() {
        if (polling) clearInterval(polling);
        google.script.run.withSuccessHandler(data => {
          document.getElementById('log').innerText = data.log;
        }).stopMonitoring();
      }
    </script>
  </body>
</html>
