function extractVerificationUrls(emailText) {
  const urlPattern = /https:\/\/elevenlabs\.io\/app\/action\?mode=verifyEmail&[^)\s]+/g;
  const matches = emailText.match(urlPattern);
  return matches || [];
}

function fetchInbox() {
  const props = PropertiesService.getScriptProperties();
  if (props.getProperty('monitoring') !== 'true') return;

  const token = props.getProperty('token');
  const email = props.getProperty('email');
  const ss = ensureSpreadsheet();
  const sheet = ss.getSheetByName(SHEET_NAME);
  const lastRow = sheet.getLastRow();

  const loggedIDs = new Set(
    sheet.getRange(2, ID_COLUMN, lastRow - 1).getValues().flat().filter(id => id)
  );

  const inboxRes = UrlFetchApp.fetch("https://api.mail.tm/messages", {
    headers: { Authorization: `Bearer ${token}` }
  });

  const messages = JSON.parse(inboxRes.getContentText())['hydra:member'];
  if (!messages || messages.length === 0) return;

  logProcess(`üì© Fetched ${messages.length} messages`);

  const newRows = [];

  messages.forEach(msg => {
    if (loggedIDs.has(msg.id)) return;

    const fullRes = UrlFetchApp.fetch(`https://api.mail.tm/messages/${msg.id}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const full = JSON.parse(fullRes.getContentText());

    const otp = full.text.match(/\b\d{4,8}\b/);
    const link = full.text.match(/https?:\/\/[^\s]+/);
    const verificationUrls = extractVerificationUrls(full.text);
    const verificationUrl = verificationUrls.length > 0 ? verificationUrls[0] : "NULL";

    newRows.push([
      email,                 // Column 1
      msg.createdAt,         // Column 2
      msg.from.address,      // Column 3
      msg.subject,           // Column 4
      otp ? otp[0] : "NULL", // Column 5
      link ? link[0] : "NULL", // Column 6 (first found URL, generic)
      full.text,             // Column 7 (raw content)
      msg.id,                // Column 8 (message ID)
      verificationUrl        // Column 9 (new: ElevenLabs verification URL)
    ]);

    logProcess("‚úÖ Logged new message: " + msg.subject);
  });

  if (newRows.length) {
    sheet.getRange(lastRow + 1, 1, newRows.length, newRows[0].length).setValues(newRows);
  } else {
    logProcess("‚ÑπÔ∏è No new messages to log.");
  }
}
