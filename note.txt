let token = '';
let account = {};
let lastMessageIds = new Set();
let triggerId = '';
let logHistory = [];

function doGet() {
  return HtmlService.createHtmlOutputFromFile('Page')
    .setTitle('Mail.tm Inbox Monitor')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function startMonitoring() {
  token = '';
  account = {};
  lastMessageIds = new Set();
  logHistory = [];

  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  sheet.clear();
  sheet.appendRow(['Type', 'Timestamp', 'Email Address', 'Sender', 'Subject', 'OTP', 'Verification Link', 'Body']);

  // Get domain
  const domains = JSON.parse(UrlFetchApp.fetch('https://api.mail.tm/domains').getContentText());
  const domain = domains['hydra:member'][0].domain;

  const email = 'temp' + Math.floor(Math.random() * 100000) + '@' + domain;
  const password = 'Test1234!';

  // Register account
  UrlFetchApp.fetch('https://api.mail.tm/accounts', {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify({ address: email, password: password }),
    muteHttpExceptions: true
  });

  // Login
  const loginResponse = UrlFetchApp.fetch('https://api.mail.tm/token', {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify({ address: email, password: password })
  });

  const loginData = JSON.parse(loginResponse.getContentText());
  token = loginData.token;
  account.email = email;
  account.password = password;

  const now = new Date();
  sheet.appendRow(['INIT', now, email, '', '', '', '', '']);
  logHistory.push(`[${now.toLocaleString()}] Monitoring started. Email: ${email}`);

  // Trigger every minute
  const trigger = ScriptApp.newTrigger('pollInbox')
    .timeBased()
    .everyMinutes(1)
    .create();
  triggerId = trigger.getUniqueId();

  return { email, log: logHistory.join('\n') };
}

function pollInbox() {
  if (!token) return;

  const inbox = UrlFetchApp.fetch('https://api.mail.tm/messages', {
    method: 'get',
    headers: { Authorization: 'Bearer ' + token }
  });
  const messages = JSON.parse(inbox.getContentText())['hydra:member'];
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();

  for (let msg of messages) {
    if (lastMessageIds.has(msg.id)) continue;
    lastMessageIds.add(msg.id);

    const details = UrlFetchApp.fetch(`https://api.mail.tm/messages/${msg.id}`, {
      method: 'get',
      headers: { Authorization: 'Bearer ' + token }
    });
    const content = JSON.parse(details.getContentText());

    const timestamp = content.createdAt;
    const sender = content.from.address;
    const subject = content.subject;
    const body = content.text;

    const otp = extractOTP(body) || 'NULL';
    const vlink = extractVerificationLink(body) || 'NULL';

    sheet.appendRow(['EMAIL', timestamp, account.email, sender, subject, otp, vlink, body]);

    const logLine = `[${new Date().toLocaleTimeString()}] Email from ${sender} | OTP: ${otp} | Link: ${vlink}`;
    logHistory.push(logLine);
  }
}

function extractOTP(text) {
  const match = text.match(/\b\d{4,8}\b/);
  return match ? match[0] : null;
}

function extractVerificationLink(text) {
  const match = text.match(/https:\/\/[^\s"]*verify[^\s"]*/i);
  return match ? match[0] : null;
}

function getLiveLog() {
  return logHistory.join('\n');
}

function stopMonitoring() {
  const allTriggers = ScriptApp.getProjectTriggers();
  for (let t of allTriggers) {
    if (t.getHandlerFunction() === 'pollInbox') {
      ScriptApp.deleteTrigger(t);
    }
  }
  logHistory.push(`[${new Date().toLocaleString()}] Monitoring stopped.`);
  return { stopped: true, log: logHistory.join('\n') };
}












<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body { font-family: Arial; padding: 20px; }
      button { margin-right: 10px; }
      #log {
        white-space: pre-wrap;
        background: #f9f9f9;
        padding: 10px;
        border-radius: 6px;
        margin-top: 20px;
        height: 400px;
        overflow-y: auto;
        border: 1px solid #ccc;
      }
    </style>
  </head>
  <body>
    <h2>Mail.tm Inbox Monitor</h2>
    <button onclick="start()">Start Monitoring</button>
    <button onclick="stop()">Stop Monitoring</button>
    <div id="log">Press "Start Monitoring" to begin...</div>

    <script>
      let polling = null;

      function start() {
        document.getElementById('log').innerText = 'Starting monitor...';
        google.script.run.withSuccessHandler(data => {
          updateLog(data.log);
          startPolling();
        }).startMonitoring();
      }

      function stop() {
        google.script.run.withSuccessHandler(data => {
          updateLog(data.log);
          stopPolling();
        }).stopMonitoring();
      }

      function updateLog(text) {
        const logDiv = document.getElementById('log');
        logDiv.innerText = text;
        logDiv.scrollTop = logDiv.scrollHeight;
      }

      function startPolling() {
        if (polling) clearInterval(polling);
        polling = setInterval(() => {
          google.script.run.withSuccessHandler(updateLog).getLiveLog();
        }, 5000); // update every 5 sec
      }

      function stopPolling() {
        if (polling) clearInterval(polling);
      }
    </script>
  </body>
</html>
